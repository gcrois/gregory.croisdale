---
import type { CollectionEntry } from "astro:content";
import { dateToParts, stringToDate } from "src/utils/date";
import { FaExternalLinkAlt } from "react-icons/fa";
import { MdComputer } from "react-icons/md";
import DynamicImage from "./DynamicImage.astro";

interface Props {
	post: CollectionEntry<"blog"> | CollectionEntry<"research">;
	dateFunc?: (date: Date) => string;
}

const {
	post,
	dateFunc = (date: Date) => {
		const { month, day, year } = dateToParts(date);
		const dayStr = day.toString().replace(/^0+/, "");
		return `${month} ${dayStr}, ${year}`;
	},
}: Props = Astro.props;
const link =
	post.data.link == "" ? `${post.collection}/${post.slug}` : post.data.link;
const domain = post.data.newTab ? new URL(link).hostname : null;
---

<style lang="scss">
	.content-card-container {
		width: 100%;
		display: flex;
	}

	.content-card {
		display: flex;
		flex-direction: column;
		width: 100%;
		border-radius: var(--radius-md);
		background-color: rgba(255, 255, 255, 0.8); // More opaque
		backdrop-filter: blur(8px);
		border: 1px solid var(--bg-border);
		box-shadow: var(--shadow-sm);
		transition: all var(--transition);
		overflow: hidden;
		text-decoration: none;

		&:hover {
			transform: translateY(-4px);
			box-shadow: var(--shadow-lg);
			background-color: rgba(255, 255, 255, 0.9);

			.read-more::after {
				transform: translateX(4px);
			}
		}
	}

	.image-container {
		width: 100%;
		height: 200px;
		background: linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;

		img {
			width: 100%;
			height: 100%;
			object-fit: contain;
			image-rendering: pixelated;
		}

		.default-icon {
			font-size: 4rem;
			color: #9ca3af;
		}
	}

	.card-desc {
		display: flex;
		flex-direction: column;
		padding: 1.5rem;
		flex: 1;
	}

	.tags {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
		margin-bottom: 1rem;
	}

	.tag {
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: var(--primary);
		background-color: rgba(37, 99, 235, 0.1); // Primary with opacity
		padding: 0.25rem 0.5rem;
		border-radius: 4px;
	}

	.card-title {
		font-size: 1.25rem;
		font-weight: 700;
		line-height: 1.4;
		margin: 0 0 0.5rem 0;
		color: var(--text-main);
	}

	.meta-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-size: 0.875rem;
		color: var(--text-secondary);
		margin-bottom: 1rem;
		flex-wrap: wrap;
	}

	.meta-separator {
		opacity: 0.5;
	}

	.authors {
		display: flex;
		align-items: center;
		flex-wrap: wrap;
		gap: 0.3rem;
	}

	.author {
		font-weight: 500;
		color: var(--text-main);
		background: rgba(0, 0, 0, 0.05);
		padding: 0 0.4rem;
		border-radius: 4px;
		font-size: 0.85rem;
	}

	.author-greg {
		font-weight: 700;
		color: var(--primary);
		background: rgba(37, 99, 235, 0.1);
	}

	.card-description {
		font-size: 0.95rem;
		line-height: 1.6;
		color: var(--text-secondary);
		margin-bottom: 1.5rem;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.card-footer {
		margin-top: auto;
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding-top: 1rem;
		border-top: 1px solid rgba(0, 0, 0, 0.05);
	}

	.read-more {
		color: var(--primary);
		font-weight: 600;
		font-size: 0.875rem;
		display: flex;
		align-items: center;
		gap: 0.25rem;

		&::after {
			content: "â†’";
			transition: transform 0.2s ease;
		}
	}

	.external-icon {
		position: absolute;
		top: 1rem;
		right: 1rem;
		background: white;
		padding: 0.5rem;
		border-radius: 50%;
		box-shadow: var(--shadow-md);
		color: var(--text-main);
		z-index: 10;
		display: flex;
		align-items: center;
		justify-content: center;
	}
</style>

<div class="content-card-container">
	<a
		href={link}
		target={post.data.newTab ? "_blank" : undefined}
		rel={post.data.newTab ? "noopener noreferrer" : undefined}
		class="content-card"
		data-tags={post.data.tags.join(",")}
	>
		{
			post.data.newTab && (
				<div class="external-icon">
					<FaExternalLinkAlt size={16} />
				</div>
			)
		}
		<div class="image-container">
			{
				post.data.image === "/images/me.jpg" ? (
					<MdComputer className="default-icon" color="white" />
				) : (
					<DynamicImage
						imagePath={post.data.image}
						altText="Post thumbnail"
						className="card-image"
					/>
				)
			}
		</div>
		<span class="card-desc">
			<div class="tags">
				{
					post.data.tags.map((tag: string) => (
						<span class="tag">{tag}</span>
					))
				}
			</div>
			<h2 class="card-title"><Fragment set:html={post.data.title} /></h2>
			<div class="meta-row">
				<time
					><Fragment
						set:html={dateFunc(stringToDate(post.data.date))}
					/></time
				>
				{
					"venue" in post.data && (
						<>
							<span class="meta-separator">|</span>
							<span>
								<Fragment set:html={post.data.venue} />
							</span>
						</>
					)
				}
				{
					"authors" in post.data && (
						<div class="authors">
							{post.data.authors.map(
								(author: string, index: number) => (
									<>
										<span
											class={
												"author" +
												(author == "Gregory Croisdale"
													? " author-greg"
													: "")
											}
										>
											<Fragment set:html={author} />
										</span>
									</>
								)
							)}
						</div>
					)
				}
			</div>
			<p class="card-description">
				<Fragment set:html={post.data.description} />
			</p>
			<div class="card-footer">
				<span class="read-more">Read more</span>
				{
					post.data.newTab && (
						<div class="heads-up">
							<FaExternalLinkAlt
								size={12}
								className="external-link-icon"
							/>
							Opens at {domain}
						</div>
					)
				}
			</div>
		</span>
	</a>
</div>

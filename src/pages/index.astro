---
import { getCollection } from "astro:content";
import Layout from "@layouts/DefaultLayout.astro";
import ContentCard from "@components/ContentCard.astro";
import Section from "@components/Section.astro";
import { dateToParts } from "src/utils/date";
import { DevToolsStatus } from "@components/fun/Console";
import { FaRss } from "react-icons/fa";

const allBlogPosts = (await getCollection("blog")).filter(
	(post) => !post.data.unlisted
);
const allResearchPosts = (await getCollection("research")).filter(
	(post) => !post.data.unlisted
);
const sortedBlogPosts = [...allBlogPosts].sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const seriesPostCountById = new Map<string, number>();
const latestSeriesPostById = new Map<string, (typeof allBlogPosts)[number]>();
const standaloneBlogPosts: (typeof allBlogPosts)[number][] = [];

for (const post of sortedBlogPosts) {
	const series = post.data.series;
	if (!series) {
		standaloneBlogPosts.push(post);
		continue;
	}

	seriesPostCountById.set(
		series.id,
		(seriesPostCountById.get(series.id) ?? 0) + 1
	);
	if (!latestSeriesPostById.has(series.id)) {
		latestSeriesPostById.set(series.id, post);
	}
}

const visibleBlogPosts = [
	...standaloneBlogPosts,
	...Array.from(latestSeriesPostById.values()),
].sort(
	(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const visibleBlogTags = Array.from(
	new Set(visibleBlogPosts.flatMap((post) => post.data.tags))
).sort((a, b) => a.localeCompare(b));
const blogCards = visibleBlogPosts.map((post) => {
	const series = post.data.series;
	if (!series) {
		return { post };
	}

	const seriesCount = seriesPostCountById.get(series.id) ?? 1;
	if (seriesCount <= 1) {
		return { post };
	}

	return {
		post,
		series: {
			title: series.title,
			count: seriesCount,
		},
	};
});
---

<style lang="scss">
	.section-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
		margin: 0.5rem 0;

		@media screen and (max-width: 768px) {
			grid-template-columns: 1fr;
			padding: 0 1rem;
			justify-items: center;
		}
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.controls-container {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
		gap: 1rem;
		background: rgba(255, 255, 255, 0.6);
		backdrop-filter: blur(10px);
		padding: 0.75rem 1rem;
		border-radius: 12px;
		border: 1px solid var(--bg-border);
	}

	.filter-container {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.filter-tag {
		background: transparent;
		border: none;
		padding: 0.4rem 0.8rem;
		border-radius: 6px;
		font-size: 0.85rem;
		font-weight: 500;
		cursor: pointer;
		color: var(--text-secondary);
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		position: relative;

		&:hover {
			color: var(--text-main);
			background: rgba(0, 0, 0, 0.05);
		}

		&.active {
			color: var(--primary);
			background: rgba(37, 99, 235, 0.1);
			font-weight: 600;
		}
	}

	.rss-link {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		color: var(--text-secondary);
		text-decoration: none;
		font-size: 0.9rem;
		font-weight: 500;
		padding: 0.4rem 0.8rem;
		border-radius: 6px;
		transition: all 0.2s ease;

		&:hover {
			background: rgba(219, 39, 119, 0.1); // Rose tint
			color: var(--secondary);
		}
	}
</style>

<script>
	const filterButtons = document.querySelectorAll(".filter-tag");
	const blogGrid = document.getElementById("blog-grid");

	if (blogGrid) {
		const cards = blogGrid.querySelectorAll(".content-card");

		filterButtons.forEach((button) => {
			button.addEventListener("click", () => {
				// Remove active class from all buttons
				filterButtons.forEach((btn) => btn.classList.remove("active"));
				// Add active class to clicked button
				button.classList.add("active");

				const filter = button.getAttribute("data-filter");

				cards.forEach((card) => {
					// Cast card to HTMLElement to access dataset
					const cardEl = card as HTMLElement;
					const tags = cardEl.dataset.tags?.split(",") || [];
					// Find the parent container to hide
					const container = cardEl.closest(
						".content-card-container"
					) as HTMLElement;

					if (filter === "all" || tags.includes(filter || "")) {
						if (container) container.style.display = "flex";
						// Re-trigger animation if needed, or just let it show
					} else {
						if (container) container.style.display = "none";
					}
				});
			});
		});
	}
</script>

<Layout
	title="Home"
	pageTitle="Gregory | Home"
	description="Hello! ðŸ‘‹ I'm Gregory Croisdale, the founding engineer at Khaki."
>
	<main id="main" class="sections-container">
		<DevToolsStatus client:load />
		<Section id="about">
			<h1>About</h1>
			Hello! ðŸ‘‹ I'm Gregory Croisdale, the founding engineer at <a
				href="https://khaki.email"
				target="_blank">Khaki</a
			>. Previously, I was a PhD candidate at the University of Michigan
			studying Human-Computer Interaction. My research was focused around
			improving communication between Humans and AI.
			<br /><br />
			I'm also a huge philosophy, art, music, and food nerd. I dabble in 3d
			Modeling (<a href="https://www.blender.org/">Blender</a> is my all-time
			favorite piece of software), violin, ukulele, and overambituous book-purchasing.
		</Section>

		<Section id="blog">
			<h1>Blog</h1>
			<div class="controls-container">
				<div class="filter-container">
					<button class="filter-tag active" data-filter="all"
						>All</button
					>
					{
						visibleBlogTags.map((tag) => (
							<button class="filter-tag" data-filter={tag}>
								{tag}
							</button>
						))
					}
				</div>
				<a
					href="/rss.xml"
					target="_blank"
					class="rss-link"
					aria-label="RSS Feed"
					title="Subscribe to RSS Feed"
				>
					<FaRss />
					<span>RSS</span>
				</a>
			</div>

			<div class="section-grid" id="blog-grid">
				{
					blogCards.map((card) => (
						<ContentCard post={card.post} series={card.series} />
					))
				}
			</div>
		</Section>

		<Section id="research">
			<h1>Research</h1>
			<div class="section-grid">
				{
					allResearchPosts
						.sort(
							(a, b) =>
								new Date(b.data.date).getTime() -
								new Date(a.data.date).getTime()
						)
						.map((post) => (
							<ContentCard
								dateFunc={(date) => {
									const { month, year } = dateToParts(date);

									return `${month} ${year}`;
								}}
								post={post}
							/>
						))
				}
			</div>
		</Section>
	</main>
</Layout>
